{% extends "base.html" %}

{% block title %}Add Household - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    .form-page {
        padding: 2rem 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: calc(100vh - 120px);
    }

    .form-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 0 1rem;
    }

    .form-header h1 {
        color: var(--primary);
        margin-bottom: 0.5rem;
        font-size: 2.5rem;
        font-weight: 700;
    }

    .form-header p {
        color: var(--gray);
        font-size: 1.2rem;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    .form-container {
        background: var(--white);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        max-width: 1200px;
        margin: 0 auto;
    }

    @media (min-width: 768px) {
        .form-container {
            padding: 3rem;
        }
    }

    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .form-section {
        background: #f8fafc;
        padding: 2rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .section-title {
        color: var(--primary);
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .form-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .required::after {
        content: "*";
        color: #ef4444;
        margin-left: 0.25rem;
    }

    .form-input, .form-select {
        padding: 0.875rem 1rem;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .field-hint {
        font-size: 0.875rem;
        color: #6b7280;
        font-style: italic;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .checkbox-label {
        font-weight: 500;
        color: var(--dark);
        cursor: pointer;
    }

    .map-container {
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e2e8f0;
        background: #f8fafc;
    }

    #location-map {
        height: 100%;
        width: 100%;
    }

    .coordinates-panel {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-top: 1rem;
    }

    .coordinates-display {
        background: #1e293b;
        color: white;
        padding: 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        margin: 1rem 0;
        text-align: center;
    }

    .location-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .location-btn {
        flex: 1;
        min-width: 150px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--primary);
        border-radius: 6px;
        background: white;
        color: var(--primary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .location-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 2rem;
        border-top: 1px solid #e2e8f0;
        margin-top: 2rem;
    }

    .help-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        padding: 2rem;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
    }

    .help-title {
        color: var(--primary);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .help-steps {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .help-step {
        padding: 0.75rem 0;
        color: var(--dark);
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .help-step:last-child {
        border-bottom: none;
    }

    .step-number {
        background: var(--primary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .map-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        background: #f8fafc;
        color: var(--gray);
        flex-direction: column;
        gap: 1rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .form-header h1 {
            font-size: 2rem;
        }
        
        .form-section {
            padding: 1.5rem;
        }
        
        .location-buttons {
            flex-direction: column;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-actions .btn {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-page">
    <div class="container">
        <div class="form-header">
            <h1>Add New Household</h1>
            <p>Register a new household in Barangay Cagpile. Fill in the information below and set the location on the map.</p>
        </div>

        <div class="form-container">
            <form method="POST" class="household-form" id="householdForm">
                <div class="form-sections">
                    <!-- Household Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">üè†</div>
                            <h2 class="section-title">Household Information</h2>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="household_id" class="form-label required">Household ID</label>
                                <input type="text" id="household_id" name="household_id" class="form-input" required 
                                       placeholder="CPL-101" 
                                       value="CPL-{{ (124 + households|length) if households else 101 }}">
                                <div class="field-hint">Unique identifier for the household</div>
                            </div>

                            <div class="form-group">
                                <label for="head_of_household" class="form-label required">Head of Household</label>
                                <input type="text" id="head_of_household" name="head_of_household" class="form-input" required 
                                       placeholder="Juan Dela Cruz">
                                <div class="field-hint">Full name of the household head</div>
                            </div>

                            <div class="form-group">
                                <label for="family_name" class="form-label">Family Name</label>
                                <input type="text" id="family_name" name="family_name" class="form-input" 
                                       placeholder="Dela Cruz">
                                <div class="field-hint">Family surname (optional)</div>
                            </div>

                            <div class="form-group">
                                <label for="num_residents" class="form-label">Number of Residents</label>
                                <input type="number" id="num_residents" name="num_residents" class="form-input" 
                                       min="1" max="20" value="4">
                                <div class="field-hint">Total people living in the household</div>
                            </div>

                            <div class="form-group">
                                <label for="contact" class="form-label">Contact Number</label>
                                <input type="text" id="contact" name="contact" class="form-input" 
                                       placeholder="09123456789">
                                <div class="field-hint">Primary contact number (optional)</div>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" name="has_seniors_pwd" value="true" id="has_seniors_pwd">
                            <label for="has_seniors_pwd" class="checkbox-label">
                                This household includes Senior Citizens or Persons with Disabilities (PWDs)
                            </label>
                        </div>
                    </div>

                    <!-- Location Settings -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">üìç</div>
                            <h2 class="section-title">Location Settings</h2>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="latitude" class="form-label required">Latitude</label>
                                <input type="number" id="latitude" name="latitude" class="form-input" step="any" required 
                                       value="12.2392" min="-90" max="90">
                                <div class="field-hint">Geographic coordinate (e.g., 12.2392)</div>
                            </div>

                            <div class="form-group">
                                <label for="longitude" class="form-label required">Longitude</label>
                                <input type="number" id="longitude" name="longitude" class="form-input" step="any" required 
                                       value="125.3185" min="-180" max="180">
                                <div class="field-hint">Geographic coordinate (e.g., 125.3185)</div>
                            </div>
                        </div>

                        <div class="coordinates-panel">
                            <label class="form-label">Current Coordinates</label>
                            <div class="coordinates-display" id="coordinates-display">
                                12.2392, 125.3185
                            </div>

                            <div class="location-buttons">
                                <button type="button" id="get-location-btn" class="location-btn">
                                    üìç Use Current Location
                                </button>
                                <button type="button" id="reset-location-btn" class="location-btn">
                                    üîÑ Reset to Default
                                </button>
                                <button type="button" id="pick-on-map-btn" class="location-btn">
                                    üó∫Ô∏è Pick on Map
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Map Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">üó∫Ô∏è</div>
                            <h2 class="section-title">Set Location on Map</h2>
                        </div>
                        
                        <p style="color: var(--gray); margin-bottom: 1rem;">
                            Click anywhere on the map below to set the exact household location. The marker will update automatically.
                        </p>
                        
                        <div class="map-container">
                            <div id="location-map">
                                <div class="map-loading">
                                    <div class="loading-spinner"></div>
                                    <p>Loading map...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Help Section -->
                    <div class="help-section">
                        <div class="help-title">
                            üí° How to Set the Location
                        </div>
                        <ul class="help-steps">
                            <li class="help-step">
                                <div class="step-number">1</div>
                                <div><strong>Click on the map</strong> - Simply click anywhere on the map to set the exact location</div>
                            </li>
                            <li class="help-step">
                                <div class="step-number">2</div>
                                <div><strong>Use Current Location</strong> - Get your current GPS coordinates (requires location permission)</div>
                            </li>
                            <li class="help-step">
                                <div class="step-number">3</div>
                                <div><strong>Manual Entry</strong> - Enter coordinates manually if you have them from a GPS device</div>
                            </li>
                            <li class="help-step">
                                <div class="step-number">4</div>
                                <div><strong>Drag the Marker</strong> - After placing the marker, you can drag it to adjust the position</div>
                            </li>
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Add Household
                        </button>
                        <a href="{{ url_for('household_data') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let locationMap;
let locationMarker;
let isMapInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeLocationMap();
    setupEventListeners();
    
    // Check for success message and refresh data
    const successMessage = document.querySelector('.flash-message.success');
    if (successMessage && successMessage.textContent.includes('added successfully')) {
        console.log('‚úÖ Household added successfully, refreshing map layers...');
        // Refresh the map layers after a short delay
        setTimeout(() => {
            if (typeof refreshMapLayers === 'function') {
                refreshMapLayers();
            }
        }, 1000);
    }
});

function initializeLocationMap() {
    locationMap = L.map('location-map').setView([12.2392, 125.3185], 16);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 20
    }).addTo(locationMap);
    
    locationMap.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
    });
    
    setLocation(12.2392, 125.3185);
    
    setTimeout(() => {
        document.querySelector('.map-loading').style.display = 'none';
        isMapInitialized = true;
    }, 1000);
}

function setLocation(lat, lng) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    document.getElementById('coordinates-display').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    
    if (locationMarker) {
        locationMap.removeLayer(locationMarker);
    }
    
    // Use circle marker instead of regular marker
    locationMarker = L.circleMarker([lat, lng], {
        radius: 8,
        fillColor: '#3388ff',
        color: '#000',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(locationMap);
    
    // Make circle marker draggable
    locationMarker.dragging.enable();
    locationMarker.on('dragend', function(e) {
        const newLatLng = e.target.getLatLng();
        setLocation(newLatLng.lat, newLatLng.lng);
    });
}

function setupEventListeners() {
    document.getElementById('get-location-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.innerHTML = '‚è≥ Getting Location...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setLocation(lat, lng);
                    locationMap.setView([lat, lng], 16);
                    
                    document.getElementById('get-location-btn').innerHTML = 'üìç Use Current Location';
                    document.getElementById('get-location-btn').disabled = false;
                },
                function(error) {
                    alert('Unable to get your location. Please enable location services and try again.');
                    document.getElementById('get-location-btn').innerHTML = 'üìç Use Current Location';
                    document.getElementById('get-location-btn').disabled = false;
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
    
    document.getElementById('reset-location-btn').addEventListener('click', function() {
        setLocation(12.2392, 125.3185);
        locationMap.setView([12.2392, 125.3185], 16);
    });
    
    document.getElementById('pick-on-map-btn').addEventListener('click', function() {
        alert('Click anywhere on the map to set the household location.');
    });
    
    document.getElementById('latitude').addEventListener('change', updateMarkerFromForm);
    document.getElementById('longitude').addEventListener('change', updateMarkerFromForm);
}

function updateMarkerFromForm() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    
    if (!isNaN(lat) && !isNaN(lng)) {
        setLocation(lat, lng);
        locationMap.setView([lat, lng], locationMap.getZoom());
    }
}
</script>
{% endblock %}