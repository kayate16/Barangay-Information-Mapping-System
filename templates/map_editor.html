{% extends "base.html" %}

{% block title %}GIS Editor - Barangay Cagpile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<style>
    .editor-page {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background: #f8fafc;
    }

    .editor-header {
        background: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-bottom: 1px solid #e2e8f0;
    }

    .editor-header h1 {
        color: var(--primary);
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .editor-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .editor-sidebar {
        width: 320px;
        background: white;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .editor-main {
        flex: 1;
        position: relative;
        background: #e2e8f0;
    }

    #editor-map {
        width: 100%;
        height: 100%;
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
    }

    .tab-btn {
        flex: 1;
        padding: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: var(--gray);
        transition: all 0.3s ease;
    }

    .tab-btn.active {
        background: var(--primary);
        color: white;
    }

    .tab-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    .tool-section {
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--dark);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tool-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .tool-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 0.5rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .tool-btn:hover {
        border-color: var(--primary);
        background: #f0f7ff;
    }

    .tool-btn.active {
        border-color: var(--primary);
        background: #dbeafe;
        color: var(--primary);
    }

    .tool-icon {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }

    .tool-label {
        font-size: 0.8rem;
        font-weight: 500;
    }

    .layer-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .layer-item {
        display: flex;
        align-items: center;
        padding: 0.8rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .layer-checkbox {
        margin-right: 0.8rem;
        transform: scale(1.2);
    }

    .layer-name {
        flex: 1;
        font-weight: 500;
    }

    .attribute-panel {
        width: 320px;
        background: white;
        border-left: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .panel-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0;
    }

    .panel-content {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
    }

    .no-selection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: var(--gray);
    }

    .no-selection i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #cbd5e1;
    }

    .attribute-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark);
    }

    .form-input {
        padding: 0.75rem;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
    }

    .editor-btn {
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        flex: 2;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
        flex: 1;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .map-controls {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
        z-index: 1000;
    }

    .zoom-controls {
        display: flex;
        flex-direction: column;
    }

    .zoom-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        transition: background 0.3s ease;
    }

    .zoom-btn:hover {
        background: #f8fafc;
    }

    .zoom-btn:first-child {
        border-bottom: 1px solid #e2e8f0;
    }

    .map-banner {
        position: absolute;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,255,255,0.95);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-size: 0.9rem;
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .status-bar {
        background: var(--dark);
        color: white;
        padding: 0.5rem 1.5rem;
        display: flex;
        gap: 2rem;
        font-size: 0.8rem;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Hide Leaflet's default draw toolbar */
    .leaflet-draw-toolbar {
        display: none !important;
    }

    .leaflet-draw-toolbar-top {
        display: none !important;
    }

    @media (max-width: 1024px) {
        .editor-sidebar,
        .attribute-panel {
            width: 280px;
        }
    }

    @media (max-width: 768px) {
        .editor-container {
            flex-direction: column;
        }
        
        .editor-sidebar {
            width: 100%;
            height: 200px;
            order: 2;
        }
        
        .editor-main {
            height: 400px;
            order: 1;
        }
        
        .attribute-panel {
            width: 100%;
            height: 250px;
            order: 3;
        }
        
        .tool-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-page">
    <div class="editor-header">
        <h1>Barangay Cagpile GIS Editor</h1>
    </div>

    <div class="editor-container">
        <!-- Sidebar -->
        <aside class="editor-sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="tools">Tools</button>
                <button class="tab-btn" data-tab="layers">Layers</button>
            </div>
            <div class="tab-content">
                <!-- Tools Tab -->
                <div class="tab-panel active" id="tools-panel">
                    <div class="tool-section">
                        <h3 class="section-title">Select & Edit</h3>
                        <div class="tool-grid">
                            <button class="tool-btn active" data-tool="select" id="tool-select">
                                <div class="tool-icon">üìç</div>
                                <div class="tool-label">Select</div>
                            </button>
                            <button class="tool-btn" data-tool="edit" id="tool-edit">
                                <div class="tool-icon">‚úèÔ∏è</div>
                                <div class="tool-label">Edit</div>
                            </button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3 class="section-title">Draw Features</h3>
                        <div class="tool-grid">
                            <button class="tool-btn" data-tool="marker" id="tool-marker">
                                <div class="tool-icon">üìå</div>
                                <div class="tool-label">Marker</div>
                            </button>
                            <button class="tool-btn" data-tool="polygon" id="tool-polygon">
                                <div class="tool-icon">‚¨¢</div>
                                <div class="tool-label">Polygon</div>
                            </button>
                            <button class="tool-btn" data-tool="rectangle" id="tool-rectangle">
                                <div class="tool-icon">‚¨õ</div>
                                <div class="tool-label">Rectangle</div>
                            </button>
                            <button class="tool-btn" data-tool="polyline" id="tool-polyline">
                                <div class="tool-icon">üìè</div>
                                <div class="tool-label">Line</div>
                            </button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3 class="section-title">Modify Features</h3>
                        <div class="tool-grid">
                            <button class="tool-btn" data-tool="move" id="tool-move">
                                <div class="tool-icon">‚ÜîÔ∏è</div>
                                <div class="tool-label">Move</div>
                            </button>
                            <button class="tool-btn" data-tool="delete" id="tool-delete">
                                <div class="tool-icon">üóëÔ∏è</div>
                                <div class="tool-label">Delete</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Layers Tab -->
                <div class="tab-panel" id="layers-panel">
                    <h3 class="section-title">Map Layers</h3>
                    <ul class="layer-list">
                        <li class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="households-layer" checked>
                            <label for="households-layer" class="layer-name">üè† Households</label>
                        </li>
                        <li class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="facilities-layer" checked>
                            <label for="facilities-layer" class="layer-name">üè¢ Facilities</label>
                        </li>
                        <li class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="roads-layer" checked>
                            <label for="roads-layer" class="layer-name">üõ£Ô∏è Roads</label>
                        </li>
                        <li class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="boundary-layer" checked>
                            <label for="boundary-layer" class="layer-name">üó∫Ô∏è Boundary</label>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Main Map -->
        <main class="editor-main">
            <div id="editor-map">
                <div style="display: flex; justify-content: center; align-items: center; height: 100%; background: #e2e8f0; color: #64748b;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                        <h3>Loading GIS Editor...</h3>
                        <p>Please wait while we initialize the map</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in">+</button>
                    <button class="zoom-btn" id="zoom-out">-</button>
                </div>
            </div>
            
            <div class="map-banner" id="map-banner">
                Using: <strong>Select</strong> Tool on <strong>Households</strong> Layer
            </div>
        </main>

        <!-- Attribute Panel -->
        <aside class="attribute-panel">
            <div class="panel-header">
                <h2 class="panel-title">Attribute Editor</h2>
            </div>
            <div class="panel-content">
                <div id="attribute-editor">
                    <div class="no-selection">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                        <h3>No Feature Selected</h3>
                        <p>Select a feature on the map to view and edit its attributes.</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <strong>Tool:</strong> <span id="current-tool">Select</span>
        </div>
        <div class="status-item">
            <strong>Layer:</strong> <span id="current-layer">Households</span>
        </div>
        <div class="status-item">
            <strong>Selected:</strong> <span id="selected-count">0</span> features
        </div>
        <div class="status-item">
            <strong>Coordinates:</strong> <span id="coordinates">125.3185, 12.2392</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>

class BarangayCagpileGISEditor {
    constructor() {
        this.map = null;
        this.drawnItems = null;
        this.drawControl = null;
        this.currentTool = 'select';
        this.currentLayer = 'households';
        this.selectedFeature = null;
        this.mapLayers = {};
        this.isDrawing = false;
        
        // API endpoints for GeoJSON data
        this.geojsonFiles = {
            households: '{{ url_for("get_households") }}',
            facilities: '{{ url_for("get_facilities") }}',
            roads: '{{ url_for("get_roads") }}',
            boundary: '{{ url_for("get_boundary") }}'
        };
        
        this.colors = {
            households: '#3388ff',
            facilities: '#27ae60', 
            roads: '#7f8c8d',
            boundary: '#ff7800'
        };
        
        this.init();
    }

    init() {
        console.log('üõ†Ô∏è Initializing Barangay Cagpile GIS Editor...');
        this.initializeMap();
        this.initializeLayers();
        this.initializeDrawControls();
        this.setupEventListeners();
        this.loadAllGeoJSONData();
        console.log('‚úÖ GIS Editor initialized successfully');
    }

    initializeMap() {
        
        this.map = L.map('editor-map', {
            center: [12.2392, 125.3185],
            zoom: 16,
            zoomControl: false // We'll use custom controls
        });
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 20
        }).addTo(this.map);
        
        // Initialize feature group for drawn items
        this.drawnItems = new L.FeatureGroup();
        this.map.addLayer(this.drawnItems);
    }

    initializeLayers() {
        // Create layer groups for each type
        this.mapLayers = {
            households: L.layerGroup(),
            facilities: L.layerGroup(),
            roads: L.layerGroup(), 
            boundary: L.layerGroup(),
            drawn: this.drawnItems
        };
        
        // Add all layers to map initially
        Object.values(this.mapLayers).forEach(layer => {
            if (layer !== this.drawnItems) {
                this.map.addLayer(layer);
            }
        });
    }

    initializeDrawControls() {
        // Initialize draw control
        this.drawControl = new L.Control.Draw({
            position: 'topright',
            edit: {
                featureGroup: this.drawnItems,
                poly: {
                    allowIntersection: false
                }
            },
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: {
                        color: '#3388ff'
                    }
                },
                polyline: {
                    shapeOptions: {
                        color: '#7f8c8d'
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#3388ff'
                    }
                },
                circle: false,
                marker: {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: 'üìç',
                        iconSize: [30, 30]
                    })
                },
                circlemarker: false
            }
        });
        
        this.map.addControl(this.drawControl);
        
        // Hide draw control initially
        this.hideDrawToolbar();
        
        // Handle draw events
        this.map.on(L.Draw.Event.CREATED, (e) => {
            this.handleDrawCreated(e);
        });
        
        this.map.on(L.Draw.Event.EDITED, (e) => {
            this.handleDrawEdited(e);
        });
        
        this.map.on(L.Draw.Event.DELETED, (e) => {
            this.handleDrawDeleted(e);
        });
    }

    setupEventListeners() {
        // Tool buttons
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tool = e.currentTarget.getAttribute('data-tool');
                this.setActiveTool(tool);
            });
        });

        // Layer controls
        document.getElementById('households-layer').addEventListener('change', (e) => {
            this.toggleLayer('households', e.target.checked);
        });

        document.getElementById('facilities-layer').addEventListener('change', (e) => {
            this.toggleLayer('facilities', e.target.checked);
        });

        document.getElementById('roads-layer').addEventListener('change', (e) => {
            this.toggleLayer('roads', e.target.checked);
        });

        document.getElementById('boundary-layer').addEventListener('change', (e) => {
            this.toggleLayer('boundary', e.target.checked);
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabName = e.currentTarget.getAttribute('data-tab');
                this.switchTab(tabName);
            });
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            this.map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            this.map.zoomOut();
        });

        // Coordinate display
        this.map.on('mousemove', (e) => {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            document.getElementById('coordinates').textContent = `${lat}, ${lng}`;
        });

        // Click on map to deselect
        this.map.on('click', (e) => {
            if (e.originalEvent.target._leaflet_id) return;
            this.deselectFeature();
        });
    }

    loadAllGeoJSONData() {
        Object.entries(this.geojsonFiles).forEach(([layerName, apiUrl]) => {
            this.loadGeoJSONLayer(layerName, apiUrl);
        });
    }

    loadGeoJSONLayer(layerName, apiUrl) {
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to load ${layerName}`);
                return response.json();
            })
            .then(data => {
                this.addGeoJSONToMap(data, layerName);
                console.log(`‚úÖ Loaded ${layerName}: ${data.features?.length || 0} features`);
            })
            .catch(error => {
                console.error(`‚ùå Error loading ${layerName}:`, error);
                this.showNotification(`Error loading ${layerName} data`, 'error');
            });
    }

    addGeoJSONToMap(geojsonData, layerName) {
        if (!geojsonData || !geojsonData.features) {
            console.warn(`No features found for ${layerName}`);
            return;
        }

        const geoJsonLayer = L.geoJSON(geojsonData, {
            pointToLayer: (feature, latlng) => {
                return L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: 'üìç',
                        iconSize: [30, 30]
                    })
                });
            },
            style: (feature) => {
                const baseStyle = {
                    color: this.colors[layerName] || '#3388ff',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.4
                };

                // Custom styles for different layers
                if (layerName === 'households') {
                    const isVulnerable = feature.properties?.['senior/PWD'] === 'YES';
                    baseStyle.fillColor = isVulnerable ? '#ff4444' : '#3388ff';
                    baseStyle.fillOpacity = 0.6;
                } else if (layerName === 'roads') {
                    baseStyle.weight = 3;
                    baseStyle.opacity = 0.7;
                    baseStyle.fillOpacity = 0;
                } else if (layerName === 'boundary') {
                    baseStyle.weight = 3;
                    baseStyle.fillOpacity = 0.1;
                    baseStyle.dashArray = '5, 5';
                }

                return baseStyle;
            },
            onEachFeature: (feature, layer) => {
                // Add popup
                const popupContent = this.createPopupContent(feature, layerName);
                layer.bindPopup(popupContent);
                
                // Add click event for selection
                layer.on('click', (e) => {
                    e.originalEvent.stopPropagation();
                    this.selectFeature(feature, layer, layerName);
                });

                // Add to the appropriate layer group
                this.mapLayers[layerName].addLayer(layer);
            }
        });
    }

    createPopupContent(feature, layerName) {
        const props = feature.properties || {};
        let content = `<div style="min-width: 200px; max-width: 300px;">`;
        content += `<h4 style="margin: 0 0 10px 0; color: #1e40af;">${layerName.charAt(0).toUpperCase() + layerName.slice(1)}</h4>`;
        
        if (layerName === 'households') {
            content += `
                <p style="margin: 5px 0;"><strong>Owner:</strong> ${props.Owner || 'N/A'}</p>
                <p style="margin: 5px 0;"><strong>Family:</strong> ${props['Family nm'] || 'N/A'}</p>
                <p style="margin: 5px 0;"><strong>Residents:</strong> ${props.Residents || '0'}</p>
                <p style="margin: 5px 0;"><strong>Senior/PWD:</strong> ${props['senior/PWD'] || 'No'}</p>
                ${props['Contact no'] ? `<p style="margin: 5px 0;"><strong>Contact:</strong> ${props['Contact no']}</p>` : ''}
            `;
        } else if (layerName === 'facilities') {
            content += `
                <p style="margin: 5px 0;"><strong>Facility:</strong> ${props.Facility || 'N/A'}</p>
                ${props.id ? `<p style="margin: 5px 0;"><strong>ID:</strong> ${props.id}</p>` : ''}
            `;
        } else if (layerName === 'roads') {
            content += `<p style="margin: 5px 0;">Road Segment</p>`;
        } else if (layerName === 'boundary') {
            content += `<p style="margin: 5px 0;">Barangay Cagpile Boundary</p>`;
        }
        
        content += `<p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;"><em>Click to edit properties</em></p>`;
        content += `</div>`;
        return content;
    }

    setActiveTool(tool) {
        this.currentTool = tool;
        
        // Update UI
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
        document.getElementById('current-tool').textContent = this.formatToolName(tool);
        
        // Update map banner
        document.getElementById('map-banner').innerHTML = 
            `Using: <strong>${this.formatToolName(tool)}</strong> Tool on <strong>${this.formatLayerName(this.currentLayer)}</strong> Layer`;

        // Enable the selected tool
        this.enableTool(tool);
    }

    enableTool(tool) {
        // Disable all drawing first
        this.hideDrawToolbar();
        this.isDrawing = false;

        switch(tool) {
            case 'select':
                // Selection mode - default
                this.map.options.dragging = true;
                break;
                
            case 'edit':
                // Enable edit mode
                if (this.drawnItems.getLayers().length > 0) {
                    new L.EditToolbar.Edit(this.map, {
                        featureGroup: this.drawnItems
                    }).enable();
                }
                break;
                
            case 'marker':
            case 'polygon':
            case 'rectangle':
            case 'polyline':
                this.startDrawing(tool);
                break;
                
            case 'move':
                // Move mode
                this.map.options.dragging = true;
                break;
                
            case 'delete':
                if (this.selectedFeature) {
                    this.deleteSelectedFeature();
                }
                this.setActiveTool('select');
                break;
        }
    }

    startDrawing(drawType) {
        this.isDrawing = true;
        this.showDrawToolbar();
        
        // Activate the specific draw tool
        setTimeout(() => {
            const drawButton = document.querySelector(`.leaflet-draw-draw-${drawType}`);
            if (drawButton) {
                drawButton.click();
            }
        }, 100);
    }

    showDrawToolbar() {
        const toolbar = document.querySelector('.leaflet-draw-toolbar-top');
        if (toolbar) {
            toolbar.style.display = 'block';
        }
    }

    hideDrawToolbar() {
        const toolbar = document.querySelector('.leaflet-draw-toolbar-top');
        if (toolbar) {
            toolbar.style.display = 'none';
        }
    }

    handleDrawCreated(e) {
        const layer = e.layer;
        const layerType = e.layerType;
        
        // Add to drawn items
        this.drawnItems.addLayer(layer);
        
        // Create new feature object
        const newFeature = {
            type: 'Feature',
            properties: this.getDefaultProperties(this.currentLayer),
            geometry: layer.toGeoJSON().geometry
        };
        
        // Add interaction
        layer.on('click', (clickEvent) => {
            clickEvent.originalEvent.stopPropagation();
            this.selectFeature(newFeature, layer, 'drawn');
        });
        
        layer.bindPopup(this.createPopupContent(newFeature, 'drawn'));
        
        // Select the new feature
        this.selectFeature(newFeature, layer, 'drawn', true);
        
        this.showNotification(`New ${layerType} created`, 'success');
        this.setActiveTool('select'); // Return to select mode after drawing
    }

    handleDrawEdited(e) {
        const layers = e.layers;
        let editedCount = 0;
        layers.eachLayer(() => {
            editedCount++;
        });
        this.showNotification(`${editedCount} features updated`, 'success');
    }

    handleDrawDeleted(e) {
        const layers = e.layers;
        let deletedCount = 0;
        layers.eachLayer(() => {
            deletedCount++;
        });
        this.deselectFeature();
        this.showNotification(`${deletedCount} features deleted`, 'success');
    }

    selectFeature(feature, layer, layerName, isNew = false) {
        // Deselect previous feature
        if (this.selectedFeature && this.selectedFeature.layer.setStyle) {
            this.resetFeatureStyle(this.selectedFeature.layer, this.selectedFeature.layerName);
        }
        
        // Select new feature
        this.selectedFeature = { feature, layer, layerName };
        
        // Highlight selected feature
        this.highlightFeature(layer);
        
        // Show attribute editor
        this.showAttributeEditor(feature.properties, layerName, isNew);
        document.getElementById('selected-count').textContent = '1';
    }

    deselectFeature() {
        if (this.selectedFeature && this.selectedFeature.layer.setStyle) {
            this.resetFeatureStyle(this.selectedFeature.layer, this.selectedFeature.layerName);
        }
        
        this.selectedFeature = null;
        document.getElementById('attribute-editor').innerHTML = this.getNoSelectionHTML();
        document.getElementById('selected-count').textContent = '0';
    }

    highlightFeature(layer) {
        if (layer.setStyle) {
            layer.setStyle({
                weight: 4,
                color: '#ff0000',
                fillOpacity: 0.8
            });
        }
    }

    resetFeatureStyle(layer, layerName) {
        if (layer.setStyle) {
            const baseStyle = {
                color: this.colors[layerName] || '#3388ff',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.4
            };

            if (layerName === 'roads') {
                baseStyle.weight = 3;
                baseStyle.fillOpacity = 0;
            } else if (layerName === 'boundary') {
                baseStyle.weight = 3;
                baseStyle.fillOpacity = 0.1;
                baseStyle.dashArray = '5, 5';
            }

            layer.setStyle(baseStyle);
        }
    }

    showAttributeEditor(properties, layerName, isNew = false) {
        const editor = document.getElementById('attribute-editor');
        editor.innerHTML = this.createAttributeForm(properties, layerName, isNew);
    }

    createAttributeForm(properties, layerName, isNew) {
        let html = `
            <div class="attribute-form">
                <h3 style="margin: 0 0 1rem 0; color: #1e40af;">
                    ${this.formatLayerName(layerName)} ${isNew ? '(New)' : '#' + (properties.id || properties.ID || 'N/A')}
                </h3>
        `;
        
        if (layerName === 'households' || layerName === 'drawn') {
            html += `
                <div class="form-group">
                    <label class="form-label">Household ID</label>
                    <input type="text" class="form-input" id="attr-id" value="${properties.id || properties.ID || ''}" ${isNew ? '' : 'readonly'}>
                </div>
                <div class="form-group">
                    <label class="form-label">Owner Name</label>
                    <input type="text" class="form-input" id="attr-owner" value="${properties.Owner || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Family Name</label>
                    <input type="text" class="form-input" id="attr-family" value="${properties['Family nm'] || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Number of Residents</label>
                    <input type="number" class="form-input" id="attr-residents" value="${properties.Residents || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Number</label>
                    <input type="text" class="form-input" id="attr-contact" value="${properties['Contact no'] || ''}">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="attr-senior-pwd" ${properties['senior/PWD'] === 'YES' ? 'checked' : ''}>
                        Includes Senior/PWD
                    </label>
                </div>
            `;
        } else if (layerName === 'facilities') {
            html += `
                <div class="form-group">
                    <label class="form-label">Facility Name</label>
                    <input type="text" class="form-input" id="attr-facility" value="${properties.Facility || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Facility ID</label>
                    <input type="text" class="form-input" id="attr-facility-id" value="${properties.id || ''}">
                </div>
            `;
        } else {
            html += `
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="attr-name" value="${properties.name || properties.Name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">ID</label>
                    <input type="text" class="form-input" id="attr-id" value="${properties.id || properties.ID || ''}">
                </div>
            `;
        }
        
        html += `
            <div class="form-actions">
                <button class="editor-btn btn-primary" onclick="gisEditor.saveAttributes()">
                    üíæ ${isNew ? 'Create' : 'Save Changes'}
                </button>
                <button class="editor-btn btn-danger" onclick="gisEditor.deleteSelectedFeature()">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>`;
        
        return html;
    }

    saveAttributes() {
        if (!this.selectedFeature) {
            this.showNotification('No feature selected', 'error');
            return;
        }
        
        const updatedProperties = {};
        const inputs = document.querySelectorAll('#attribute-editor .form-input, #attribute-editor input[type="checkbox"]');
        
        inputs.forEach(input => {
            const field = input.id.replace('attr-', '');
            if (input.type === 'checkbox') {
                updatedProperties[field] = input.checked ? 'YES' : 'NO';
            } else {
                updatedProperties[field] = input.value;
            }
        });
        
        // Update the feature properties
        this.selectedFeature.feature.properties = { 
            ...this.selectedFeature.feature.properties, 
            ...updatedProperties 
        };
        
        // Update popup content
        const popupContent = this.createPopupContent(this.selectedFeature.feature, this.selectedFeature.layerName);
        this.selectedFeature.layer.setPopupContent(popupContent);
        
        this.showNotification('Feature saved successfully!', 'success');
    }

    deleteSelectedFeature() {
        if (!this.selectedFeature) {
            this.showNotification('No feature selected', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this feature?')) return;
        
        const { layer, layerName } = this.selectedFeature;
        
        // Remove from map and layer groups
        if (this.map.hasLayer(layer)) {
            this.map.removeLayer(layer);
        }
        
        if (this.mapLayers[layerName] && this.mapLayers[layerName].hasLayer(layer)) {
            this.mapLayers[layerName].removeLayer(layer);
        }
        
        if (this.drawnItems.hasLayer(layer)) {
            this.drawnItems.removeLayer(layer);
        }
        
        this.deselectFeature();
        this.showNotification('Feature deleted successfully!', 'success');
    }

    toggleLayer(layerName, visible) {
        if (this.mapLayers[layerName]) {
            if (visible) {
                this.map.addLayer(this.mapLayers[layerName]);
            } else {
                this.map.removeLayer(this.mapLayers[layerName]);
            }
        }
        
        if (visible) {
            this.currentLayer = layerName;
            document.getElementById('current-layer').textContent = this.formatLayerName(layerName);
        }
    }

    switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(`${tabName}-panel`).classList.add('active');
    }

    getDefaultProperties(layerName) {
        const defaults = {
            households: {
                id: Date.now(),
                Owner: 'New Owner',
                'Family nm': 'New Family',
                Residents: 1,
                'senior/PWD': 'NO',
                'Contact no': ''
            },
            facilities: {
                id: Date.now(),
                Facility: 'New Facility'
            },
            drawn: {
                id: Date.now(),
                name: 'New Feature'
            }
        };
        
        return defaults[layerName] || { id: Date.now(), name: 'New Feature' };
    }

    getNoSelectionHTML() {
        return `
            <div class="no-selection">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üó∫Ô∏è</div>
                <h3>No Feature Selected</h3>
                <p>Select a feature on the map to view and edit its attributes.</p>
            </div>
        `;
    }

    formatToolName(tool) {
        const names = {
            select: 'Select',
            edit: 'Edit',
            marker: 'Marker',
            polygon: 'Polygon',
            rectangle: 'Rectangle',
            polyline: 'Polyline',
            move: 'Move',
            delete: 'Delete'
        };
        return names[tool] || tool;
    }

    formatLayerName(layerName) {
        const names = {
            households: 'Households',
            facilities: 'Facilities',
            roads: 'Roads',
            boundary: 'Boundary',
            drawn: 'Drawn Features'
        };
        return names[layerName] || layerName;
    }

    showNotification(message, type) {
        // Remove existing notifications
        document.querySelectorAll('.gis-notification').forEach(notif => notif.remove());
        
        const notification = document.createElement('div');
        notification.className = `gis-notification flash-message ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
            ${message}
        `;
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
    }
}

// Initialize the GIS Editor when the page loads
let gisEditor;

document.addEventListener('DOMContentLoaded', function() {
    gisEditor = new BarangayCagpileGISEditor();
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    .custom-marker {
        background: none !important;
        border: none !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}